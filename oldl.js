oldl={},oldl.BaseDataLayer=function(a,e,o,t,n,r,i,u,l,d,c,s,f,g,h){o=o||{};var y=this,v=t();(v.__oldl=this).getName=function(){return e},this.getLayer=function(){return v},this.load=function(e,t){!t&&("function"==typeof e||e instanceof Function)&&(t=e,e=void 0),t?o.onLoad(e,function(e){m(e),t&&t()}):o.onLoad(e,m)},this.fit=function(e){var t;if(arguments.length){t=ol.extent.createEmpty();for(var n=0,r=arguments.length;n<r;++n)t=ol.extent.extend(t,y.getFeatureExtent(y.getFeatureData(arguments[n])))}else t=y.getExtent();t&&!ol.extent.isEmpty(t)&&a.getView().fit(t)},this.getExtent=function(){return i()},this.show=function(e){n(e)},this.isVisible=function(){return r()},this.getFeatureById=function(e){return l(e)},this.getFeatureId=function(e){return e.__oldlFId},this.getFeatureData=function(e){return e.__oldlData},this.getFeature=function(e){return y.getFeatureById(function(e){var t=o.id(e);if(null==t||null==t)throw"Invalid feature data! Failed to obtain ID from "+JSON.stringify(e);return t}(e))},this.getFeatureExtent=function(e){var t=y.getFeature(e);return t?u(t):null},this.getFeatureLabel=function(e){return o.name(e?y.getFeatureData(e):void 0)},this.hasFeatureProperties=function(){return!!o.props},this.getFeatureProperties=function(e){return o.props(y.getFeatureData(e),e.__oldlIdx,e.__oldlMore)},this.getEditForm=function(){return o.form};var _=!(this.isEditable=function(){return!!o.form});function m(e){y.rollback(),s(),_=!0;for(var t=0;t<e.length;++t)y.create(e[t]);_=!1}this.isEditing=function(){return g()},this.edit=function(e){if(!y.isEditable())throw"Invalid operation: this layer is not editable!";e&&!y.isEditing()?f():!e&&y.isEditing()&&h()};var I={};function F(e,t,n){if(!_&&JSON.stringify(t)!=JSON.stringify(n)){var r=y.getFeatureId(e);e.__oldlIdx&&(r=r.substr(0,r.length-("#"+e.__oldlIdx).length));var a=I[r];n&&Object.getOwnPropertyNames(n).length?a?a.new=Object.assign({},n):(I[r]={new:Object.assign({},n),old:t?Object.assign({},t):null},a=I[r]):(a||(I[r]={old:Object.assign({},t)},a=I[r]),a.old?a.new=null:delete I[r]),a&&JSON.stringify(a.old)==JSON.stringify(a.new)&&delete I[r]}}function w(e){var t=o.id(e);if(null==t||null==t)throw"Invalid feature data! Failed to obtain ID from "+JSON.stringify(e);return t}function L(){if(!_&&!y.isEditing())throw"Invalid operation: enable editing using startEditing()!"}function p(e){var t,n=w(e),r=o.feature(e);if(!r&&!r.length)throw"Invalid feature data! Failed to create feature from "+JSON.stringify(e);Array.isArray(r)||(r=[r]);for(var a=r.length-1;0<=a;--a)(t=r[a]).__oldlFId=0==a?n:n+"#"+a,t.__oldlIdx=a,t.__oldlMore=r.length-1,t.__oldlData=e,t.__oldl=y,d(r[a]);return r[0]}function x(e){var t=w(e),n=l(t);if(c(n),n)for(var r=n.__oldlMore||0,a=1;a<r+1;++a)c(l(t+"#"+a));return n}this.create=function(e){L();var t=w(e);if(l(t))return!1;var n=p(e);return delete n.__oldlData,F(n,null,e),n.__oldlData=e,!0},this.update=function(e){L();var t=w(e),n=l(t);if(!n)throw"No feature available for update with data "+JSON.stringify(e);JSON.stringify(n.__oldlData)!=JSON.stringify(e)&&(x(n.__oldlData),F(n,n.__oldlData,e),p(e))},this.delete=function(e){L();var t=x(e);return!!t&&(F(t,t.__oldlData,null),!0)},this.revert=function(e){var t=w(e),n=I[t];n&&(n.old?(n.new&&x(n.new),p(n.old)):x(n.new),delete I[t])},this.numUnsavedChanges=function(){return Object.getOwnPropertyNames(I).length},this.processFeatureChanges=function(e){L();var t=Object.assign({},e.__oldlData);o.update(t,e,e.__oldlIdx||0,e.__oldlMore||0);var n=o.id(t);if(e.__oldlIdx&&(n+="#"+e.__oldlIdx),y.getFeatureId(e)!=n)throw"Dev error: ID changed after feature update!";F(e,e.__oldlData,t),e.__oldlData=t},this.forEachModification=function(e){var t,n={added:0,updated:0,deleted:0};for(var r in I)I.hasOwnProperty(r)&&((t=I[r]).old?t.new?(n.updated++,e&&e.onUpdate&&e.onUpdate(t.old,t.new)):(n.deleted++,e&&e.onDelete&&e.onDelete(t.old)):(n.added++,e&&e.onAdd&&e.onAdd(t.new)));return n};var D={onAdd:function(t){o.onAdd(t,function(e){JSON.stringify(e)!=JSON.stringify(t)&&(x(t),e&&p(e)),delete I[w(t)]})},onUpdate:function(e,t){o.onUpdate(e,t,function(e){JSON.stringify(e)!=JSON.stringify(t)&&(x(t),e&&p(e)),delete I[w(t)]})},onDelete:function(t){o.onDelete(t,function(e){JSON.stringify(e)!=JSON.stringify(t)&&(x(t),e&&p(e)),delete I[w(t)]})}};this.save=function(){return y.forEachModification(D)};var S={onAdd:function(e){var t=x(e);delete I[y.getFeatureId(t)]},onUpdate:function(e,t){var n=x(t);p(e),delete I[y.getFeatureId(n)]},onDelete:function(e){var t=p(e);delete I[y.getFeatureId(t)]}};this.rollback=function(){return y.forEachModification(S)},v.setVisible(1!=o.doNotShow),a.addLayer(v),o.doNotAutoLoad||y.load()},oldl.BaseDataLayer.extract=function(e){return e&&e.__oldl},oldl.VectorDataLayer=function(e,t,n){var r,a,o=this;function i(e){hideMetroCharm(".edit-form.charm")}function u(e){for(var t,n=e.features.getArray(),r=0;r<n.length;++r)t=n[r],o.processFeatureChanges(t)}oldl.BaseDataLayer.call(this,e,t,n,function(){return new ol.layer.Vector({name:t,source:new ol.source.Vector})},function(e){o.getLayer().setVisible(e)},function(){return o.getLayer().getVisible()},function(){return o.getLayer().getSource().getExtent()},function(e){return e.getGeometry().getExtent()},function(e){return o.getLayer().getSource().getFeatureById(e)},function(e){e.setId(o.getFeatureId(e)),o.getLayer().getSource().addFeature(e)},function(e){o.getLayer().getSource().removeFeature(e)},function(){o.getLayer().getSource().clear()},function(){(r=new ol.interaction.Modify({source:o.getLayer().getSource()})).addEventListener("modifystart",i),r.addEventListener("modifyend",u),e.addInteraction(r),a=new ol.interaction.Snap({source:o.getLayer().getSource()}),e.addInteraction(a)},function(){return!!r},function(){e.removeInteraction(r),e.removeInteraction(a),a=r=null})},oldl.ImageDataLayer=function(e,i,t){var a=this,r={},o={},n=!1;function u(e){return[e.x,e.y,e.x+e.mPerPx*e.width,e.y+e.mPerPx*e.height]}oldl.BaseDataLayer.call(this,e,i,t,function(){return new ol.layer.Group({layers:[]})},function(e){a.getLayer().setVisible(e)},function(){return a.getLayer().getVisible()},function(){for(var e=ol.extent.createEmpty(),t=a.getLayer().getLayers().getArray(),n=0,r=t.length;n<r;++n)ol.extent.extend(e,t[n].getExtent());return e},function(e){return u(e)},function(e){return r[e]},function(e){var t=a.getFeatureId(e),n=function(e,t){var n=u(t),r=new ol.layer.Image({name:i+":"+e,source:new ol.source.ImageStatic({})});if(r.setExtent(n),t.src instanceof File)if(0!=t.src.type.indexOf("image/"))console.error("Invalid file '"+t.src.name+"': not an image!");else{var a=new FileReader;a.onload=function(e){var t=new Image;t.src=e.target.result,t.onload=function(){r.setSource(new ol.source.ImageStatic({url:this.src,imageExtent:n}))}},a.readAsDataURL(t.src)}else r.setSource(new ol.source.ImageStatic({url:t.src,imageExtent:n}));for(var o in t)t.hasOwnProperty(o)&&0==o.indexOf("__oldl")&&(r[o]=t[o]);return r.__oldlImgFeature=t,r}(t,e);a.getLayer().getLayers().push(n),o[t]=n,r[t]=e},function(e){var t=a.getFeatureId(e),n=o[t];a.getLayer().getLayers().remove(n),delete o[t],delete r[t]},function(){a.getLayer().getLayers().clear(),o={},r={}},function(){n=!0},function(){return n},function(){n=!1}),this.setImageFile=function(n,e){if(0!=n.type.indexOf("image/"))return console.error("Invalid file '"+n.name+"': not an image!"),!1;var r=a.getFeature(e);if(!r)return!1;var t=new FileReader;return t.onload=function(e){var t=new Image;t.src=e.target.result,t.onload=function(){var e=o[a.getFeatureId(r)];r.src=n,r.width=this.width,r.height=this.height;var t=u(r);e.setSource(new ol.source.ImageStatic({url:this.src,imageExtent:t})),a.processFeatureChanges(r),e.setExtent(t)}},t.readAsDataURL(n),!0}},oldl.ImageDataLayer.getFeatureFromImageLayer=function(e){return e.__oldlImgFeature};
